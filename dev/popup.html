<html>
<head>
<link href="style.css" rel="stylesheet" type="text/css" />

<script type="text/javascript">
	var ajax_transport = new XMLHttpRequest();
	update_notifications();

	function search()
	{
		var q = document.getElementById("question_box").value;
		chrome.tabs.create({url: "http://www.quora.com/search?q=" + q + "&context_type=&context_id="});
	}
	
	function update_notifications()
	{
		get_notifications();
		setTimeout(update_notifications, 60000);
	}
	
	function get_notifications()
	{
		// sending request
        ajax_transport.open("GET", "http://api.quora.com/api/logged_in_user?fields=notifs", true);
        ajax_transport.onreadystatechange = process_notifications;
        ajax_transport.send(null); // Causes the error
	}
	
	function process_notifications()
	{
		if (ajax_transport.readyState != 4)
		{
            return;
		}
		
		// while(1);{"name": "Andrew Brown", "notifs": {"unseen_count": 1, "unseen": 
		// ["<a href=\"http://www.quora.com/Liz-Pullen\">Liz Pullen</a> also commented on 
		// <a href=\"http://www.quora.com/What-is-your-definition-of-a-lady/talk?__snids__=7146833#comment37899\">
		// What is your definition of a lady?</a>"], "unseen_aggregated_count": 1}}
		
		// Strip while(1);
		var response = ajax_transport.responseText;
		response = response.substring("while(1);".length);
		// Parse json
		var json = JSON.parse(response);
		
		var name = json.name;
		var n_count = json.notifs.unseen_count;
		var t_notifs = json.notifs.unseen_aggregated_count;
		var notifs = json.notifs.unseen;
		
		if (name == "undefined" || n_count == "undefined" || t_notifs == "undefined" || notifs == "undefined")
		{
			// Error reading from api
			return;
		}
		
		if (n_count > 0)
		{
			var notif_container = document.getElementById('n_list');
		
			// Add all notifications to popup
			for (var i = 0; i < (t_notifs > 5 ? 5 : t_notifs); i++)
			{
				var n = document.createElement('li');
				n.setAttribute('id', 'notif_' + i);
				n.setAttribute('class', 'notification');
				
				notif_container.appendChild(n);
				document.getElementById('notif_' + i).innerHTML = notifs[i];
			}
		}
		
		// Update badge count
		var badgeText = (n_count > 0) ? String(n_count) : "";
		chrome.browserAction.setBadgeText({text: badgeText});
	}
</script>
</head>
<body>

<div id="header">
	<a id="logo" href="http://www.quora.com" target="_quora">Quora</a>
	<form class="search_form" action="#" onsubmit="search(); return false" method="get" name="search_form">
		<input id="search_button" type="submit" value="Search" />
		<input id="question_box" type="text" value="" maxlength="150" name="q" />
		<input type="hidden" name="context_type" />
		<input type="hidden" name="context_id" />
		<input type="hidden" name="source" value="chrome-extension" />
	</form>
</div>

<div id="notifications">
	<h3 id="n_title">New Notifications</h3>
	
	<ul id="n_list">
	
	</ul>
</div>
</body>
</html>